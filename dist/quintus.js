var Quintus=function t(i){var e=function(t,i,n){return e.select(t,i,n)};e.select=function(){},e.include=function(i){return e._each(e._normalizeArg(i),function(i){var n=t[i]||i;if(!e._isFunction(n))throw"Invalid Module:"+i;n(e)}),e},e._normalizeArg=function(t){return e._isString(t)&&(t=t.replace(/\s+/g,"").split(",")),e._isArray(t)||(t=[t]),t},e._extend=function(t,i){if(!i)return t;for(var e in i)t[e]=i[e];return t},e._clone=function(t){return e._extend({},t)},e._defaults=function(t,i){if(!i)return t;for(var e in i)void 0===t[e]&&(t[e]=i[e]);return t},e._has=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e._isString=function(t){return"string"==typeof t},e._isNumber=function(t){return"[object Number]"===Object.prototype.toString.call(t)},e._isFunction=function(t){return"[object Function]"===Object.prototype.toString.call(t)},e._isObject=function(t){return"[object Object]"===Object.prototype.toString.call(t)},e._isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},e._isUndefined=function(t){return void 0===t},e._popProperty=function(t,i){var e=t[i];return delete t[i],e},e._each=function(t,i,e){if(null!=t)if(t.forEach)t.forEach(i,e);else if(t.length===+t.length)for(var n=0,s=t.length;s>n;n++)i.call(e,t[n],n,t);else for(var o in t)i.call(e,t[o],o,t)},e._invoke=function(t,i,e,n){if(null!=t)for(var s=0,o=t.length;o>s;s++)t[s][i](e,n)},e._detect=function(t,i,e,n,s){var o;if(null!=t){if(t.length===+t.length){for(var r=0,a=t.length;a>r;r++)if(o=i.call(e,t[r],r,n,s))return o;return!1}for(var h in t)if(o=i.call(e,t[h],h,n,s))return o;return!1}},e._map=function(t,i,n){var s=[];return null==t?s:t.map?t.map(i,n):(e._each(t,function(t,e,o){s[s.length]=i.call(n,t,e,o)}),t.length===+t.length&&(s.length=t.length),s)},e._uniq=function(t){t=t.slice().sort();for(var i=[],e=null,n=0;n<t.length;n++)void 0!==t[n]&&e!==t[n]&&i.push(t[n]),e=t[n];return i},e._shuffle=function(t){var i,n=[];return e._each(t,function(t,e){i=Math.floor(Math.random()*(e+1)),n[e]=n[i],n[i]=t}),n},e._keys=Object.keys||function(t){if(e._isObject(t))throw new TypeError("Invalid object");var i=[];for(var n in t)e._has(t,n)&&(i[i.length]=n);return i},e._range=function(t,i,e){e=e||1;for(var n=Math.max(Math.ceil((i-t)/e),0),s=0,o=new Array(n);n>s;)o[s++]=t,t+=e;return o};var n=0;return e._uniqueId=function(){return n++},e.options={imagePath:"images/",audioPath:"audio/",dataPath:"data/",audioSupported:["mp3","ogg"],sound:!0,frameTimeLimit:100,autoFocus:!0},i&&e._extend(e.options,i),e.gameLoop=function(t){return e.lastGameLoopFrame=(new Date).getTime(),e.loop=!0,e._loopFrame=0,e.gameLoopCallbackWrapper=function(){var i=(new Date).getTime();e._loopFrame++,e.loop=window.requestAnimationFrame(e.gameLoopCallbackWrapper);var n=i-e.lastGameLoopFrame;n>e.options.frameTimeLimit&&(n=e.options.frameTimeLimit),t.apply(e,[n/1e3]),e.lastGameLoopFrame=i},window.requestAnimationFrame(e.gameLoopCallbackWrapper),e},e.pauseGame=function(){e.loop&&window.cancelAnimationFrame(e.loop),e.loop=null},e.unpauseGame=function(){e.loop||(e.lastGameLoopFrame=(new Date).getTime(),e.loop=window.requestAnimationFrame(e.gameLoopCallbackWrapper))},function(){var t=!1,i=/xyz/.test(function(){})?/\b_super\b/:/.*/;e.Class=function(){},e.Class.prototype.isA=function(t){return this.className===t},e.Class.extend=function(n,s,o){function r(t,i){return function(){var e=this._super;this._super=h[t];var n=i.apply(this,arguments);return this._super=e,n}}function a(){!t&&this.init&&this.init.apply(this,arguments)}e._isString(n)||(o=s,s=n,n=null);var h=this.prototype,l=this;t=!0;var c=new l;t=!1;for(var u in s)c[u]="function"==typeof s[u]&&"function"==typeof h[u]&&i.test(s[u])?r(u,s[u]):s[u];return a.prototype=c,a.prototype.constructor=a,a.extend=e.Class.extend,o&&e._extend(a,o),n&&(e[n]=a,a.prototype.className=n,a.className=n),a}}(),e.Class.extend("Evented",{on:function(t,i,n){if(e._isArray(t)||-1!==t.indexOf(",")){t=e._normalizeArg(t);for(var s=0;s<t.length;s++)this.on(t[s],i,n)}else n||(n=i,i=null),n||(n=t),e._isString(n)&&(n=(i||this)[n]),this.listeners=this.listeners||{},this.listeners[t]=this.listeners[t]||[],this.listeners[t].push([i||this,n]),i&&(i.binds||(i.binds=[]),i.binds.push([this,t,n]))},trigger:function(t,i){if(this.listeners&&this.listeners[t])for(var e=0,n=this.listeners[t].length;n>e;e++){var s=this.listeners[t][e];s[1].call(s[0],i)}},off:function(t,i,n){if(i){e._isString(n)&&i[n]&&(n=i[n]);var s=this.listeners&&this.listeners[t];if(s)for(var o=s.length-1;o>=0;o--)s[o][0]===i&&(n&&n!==s[o][1]||this.listeners[t].splice(o,1))}else this.listeners[t]&&delete this.listeners[t]},debind:function(){if(this.binds)for(var t=0,i=this.binds.length;i>t;t++){var e=this.binds[t],n=e[0],s=e[1];n.off(s,this)}}}),e.components={},e.Evented.extend("Component",{init:function(t){this.entity=t,this.extend&&e._extend(t,this.extend),t[this.name]=this,t.activeComponents.push(this.componentName),t.stage&&t.stage.addToList&&t.stage.addToList(this.componentName,t),this.added&&this.added()},destroy:function(){if(this.extend)for(var t=e._keys(this.extend),i=0,n=t.length;n>i;i++)delete this.entity[t[i]];delete this.entity[this.name];var s=this.entity.activeComponents.indexOf(this.componentName);-1!==s&&(this.entity.activeComponents.splice(s,1),this.entity.stage&&this.entity.stage.addToList&&this.entity.stage.addToLists(this.componentName,this.entity)),this.debind(),this.destroyed&&this.destroyed()}}),e.Evented.extend("GameObject",{has:function(t){return this[t]?!0:!1},add:function(t){t=e._normalizeArg(t),this.activeComponents||(this.activeComponents=[]);for(var i=0,n=t.length;n>i;i++){var s=t[i],o=e.components[s];if(!this.has(s)&&o){var r=new o(this);this.trigger("addComponent",r)}}return this},del:function(t){t=e._normalizeArg(t);for(var i=0,n=t.length;n>i;i++){var s=t[i];s&&this.has(s)&&(this.trigger("delComponent",this[s]),this[s].destroy())}return this},destroy:function(){this.isDestroyed||(this.trigger("destroyed"),this.debind(),this.stage&&this.stage.remove&&this.stage.remove(this),this.isDestroyed=!0,this.destroyed&&this.destroyed())}}),e.component=function(t,i){return i?(i.name=t,i.componentName="."+t,e.components[t]=e.Component.extend(t+"Component",i)):e.components[t]},e.GameObject.extend("GameState",{init:function(t){this.p=e._extend({},t),this.listeners={}},reset:function(t){this.init(t),this.trigger("reset")},_triggerProperty:function(t,i){this.p[i]!==t&&(this.p[i]=t,this.trigger("change."+i,t))},set:function(t,i){e._isObject(t)?e._each(t,this._triggerProperty,this):this._triggerProperty(i,t),this.trigger("change")},inc:function(t,i){this.set(t,this.get(t)+i)},dec:function(t,i){this.set(t,this.get(t)-i)},get:function(t){return this.p[t]}}),e.state=new e.GameState,e.reset=function(){e.state.reset()},e.touchDevice="ontouchstart"in document,e.setup=function(t,i){e._isObject(t)&&(i=t,t=null),i=i||{},t=t||"quintus",e.el=e._isString(t)?document.getElementById(t):t,e.el||(e.el=document.createElement("canvas"),e.el.width=i.width||320,e.el.height=i.height||420,e.el.id=t,document.body.appendChild(e.el));var n=parseInt(e.el.width,10),s=parseInt(e.el.height,10),o=i.maxWidth||5e3,r=i.maxHeight||5e3,a=i.resampleWidth,h=i.resampleHeight,l=i.upsampleWidth,c=i.upsampleHeight;i.maximize===!0||e.touchDevice&&"touch"===i.maximize?(document.body.style.padding=0,document.body.style.margin=0,n=i.width||Math.min(window.innerWidth,o)-(i.pagescroll?17:0),s=i.height||Math.min(window.innerHeight-5,r),e.touchDevice&&(e.el.style.height=2*s+"px",window.scrollTo(0,1),n=Math.min(window.innerWidth,o),s=Math.min(window.innerHeight,r))):e.touchDevice&&window.scrollTo(0,1),l&&l>=n||c&&c>=s?(e.el.style.height=s+"px",e.el.style.width=n+"px",e.el.width=2*n,e.el.height=2*s):(a&&n>a||h&&s>h)&&e.touchDevice?(e.el.style.height=s+"px",e.el.style.width=n+"px",e.el.width=n/2,e.el.height=s/2):(e.el.style.height=s+"px",e.el.style.width=n+"px",e.el.width=n,e.el.height=s);var u=e.el.parentNode;return u&&(e.wrapper=document.createElement("div"),e.wrapper.id=e.el.id+"_container",e.wrapper.style.width=n+"px",e.wrapper.style.margin="0 auto",e.wrapper.style.position="relative",u.insertBefore(e.wrapper,e.el),e.wrapper.appendChild(e.el)),e.el.style.position="relative",e.ctx=e.el.getContext&&e.el.getContext("2d"),e.width=parseInt(e.el.width,10),e.height=parseInt(e.el.height,10),e.cssWidth=n,e.cssHeight=s,window.addEventListener("orientationchange",function(){setTimeout(function(){window.scrollTo(0,1)},0)}),e},e.clear=function(){e.clearColor?(e.ctx.globalAlpha=1,e.ctx.fillStyle=e.clearColor,e.ctx.fillRect(0,0,e.width,e.height)):e.ctx.clearRect(0,0,e.width,e.height)},e.setImageSmoothing=function(t){e.ctx.mozImageSmoothingEnabled=t,e.ctx.webkitImageSmoothingEnabled=t,e.ctx.msImageSmoothingEnabled=t,e.ctx.imageSmoothingEnabled=t},e.imageData=function(t){var i=document.createElement("canvas");i.width=t.width,i.height=t.height;var e=i.getContext("2d");return e.drawImage(t,0,0),e.getImageData(0,0,t.width,t.height)},e.assetTypes={png:"Image",jpg:"Image",gif:"Image",jpeg:"Image",ogg:"Audio",wav:"Audio",m4a:"Audio",mp3:"Audio"},e._fileExtension=function(t){var i=t.split("."),e=i[i.length-1].toLowerCase();return e},e.assetType=function(t){var i=e._fileExtension(t),n=e.assetTypes[i];return"Audio"===n&&e.audio&&"WebAudio"===e.audio.type&&(n="WebAudio"),n||"Other"},e.assetUrl=function(t,i){var n="";return e.options.development&&(n=(/\?/.test(i)?"&":"?")+"_t="+(new Date).getTime()),/^https?:\/\//.test(i)||"/"===i[0]?i+n:t+i+n},e.loadAssetImage=function(t,i,n,s){var o=new Image;o.onload=function(){n(t,o)},o.onerror=s,o.src=e.assetUrl(e.options.imagePath,i)},e.audioMimeTypes={mp3:"audio/mpeg",ogg:'audio/ogg; codecs="vorbis"',m4a:"audio/m4a",wav:"audio/wav"},e._audioAssetExtension=function(){if(e._audioAssetPreferredExtension)return e._audioAssetPreferredExtension;var t=new Audio;return e._audioAssetPreferredExtension=e._detect(e.options.audioSupported,function(i){return t.canPlayType(e.audioMimeTypes[i])?i:null})},e.loadAssetAudio=function(t,i,n,s){if(!document.createElement("audio").play||!e.options.sound)return void n(t,null);var o=e._removeExtension(i),r=e._audioAssetExtension(),a=new Audio;return r?(a.addEventListener("error",s),e.touchDevice||a.addEventListener("canplaythrough",function(){n(t,a)}),a.src=e.assetUrl(e.options.audioPath,o+"."+r),a.load(),void(e.touchDevice&&n(t,a))):void n(t,null)},e.loadAssetWebAudio=function(t,i,n,s){var o=new XMLHttpRequest,r=e._removeExtension(i),a=e._audioAssetExtension();o.open("GET",e.assetUrl(e.options.audioPath,r+"."+a),!0),o.responseType="arraybuffer",o.onload=function(){o.response;e.audioContext.decodeAudioData(o.response,function(i){n(t,i)},s)},o.send()},e.loadAssetOther=function(t,i,n,s){var o=new XMLHttpRequest,r=i.split("."),a=r[r.length-1].toLowerCase();o.onreadystatechange=function(){4===o.readyState&&(200===o.status?"json"===a?n(t,JSON.parse(o.responseText)):n(t,o.responseText):s())},o.open("GET",e.assetUrl(e.options.dataPath,i),!0),o.send(null)},e._removeExtension=function(t){return t.replace(/\.(\w{3,4})$/,"")},e.assets={},e.asset=function(t){return e.assets[t]},e.load=function(t,i,n){var s={};n||(n={});var o=n.progressCallback,r=!1,a=function(t){r=!0,(n.errorCallback||function(t){throw"Error Loading: "+t})(t)};e._isString(t)&&(t=e._normalizeArg(t)),e._isArray(t)?e._each(t,function(t){e._isObject(t)?e._extend(s,t):s[t]=t}):s=t;var h=e._keys(s).length,l=h,c=function(t,n,s){r||((!e.assets[t]||s)&&(e.assets[t]=n,l--,o&&o(h-l,h)),0===l&&i&&i.apply(e))};e._each(s,function(t,i){var n=e.assetType(t);e.assets[i]?c(i,e.assets[i],!0):e["loadAsset"+n](i,t,c,function(){a(t)})})},e.preloads=[],e.preload=function(t,i){e._isFunction(t)?(e.load(e._uniq(e.preloads),t,i),e.preloads=[]):e.preloads=e.preloads.concat(t)},e.matrices2d=[],e.matrix2d=function(){return e.matrices2d.length>0?e.matrices2d.pop().identity():new e.Matrix2D},e.Matrix2D=e.Class.extend({init:function(t){t?(this.m=[],this.clone(t)):this.m=[1,0,0,0,1,0]},identity:function(){var t=this.m;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,this},clone:function(t){var i=this.m,e=t.m;return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],this},multiply:function(t){var i=this.m,e=t.m,n=i[0]*e[0]+i[1]*e[3],s=i[0]*e[1]+i[1]*e[4],o=i[0]*e[2]+i[1]*e[5]+i[2],r=i[3]*e[0]+i[4]*e[3],a=i[3]*e[1]+i[4]*e[4],h=i[3]*e[2]+i[4]*e[5]+i[5];return i[0]=n,i[1]=s,i[2]=o,i[3]=r,i[4]=a,i[5]=h,this},rotate:function(t){if(0===t)return this;var i=Math.cos(t),e=Math.sin(t),n=this.m,s=n[0]*i+n[1]*e,o=n[0]*-e+n[1]*i,r=n[3]*i+n[4]*e,a=n[3]*-e+n[4]*i;return n[0]=s,n[1]=o,n[3]=r,n[4]=a,this},rotateDeg:function(t){return 0===t?this:this.rotate(Math.PI*t/180)},scale:function(t,i){var e=this.m;return void 0===i&&(i=t),e[0]*=t,e[1]*=i,e[3]*=t,e[4]*=i,this},translate:function(t,i){var e=this.m;return e[2]+=e[0]*t+e[1]*i,e[5]+=e[3]*t+e[4]*i,this},transform:function(t,i){return[t*this.m[0]+i*this.m[1]+this.m[2],t*this.m[3]+i*this.m[4]+this.m[5]]},transformPt:function(t){var i=t.x,e=t.y;return t.x=i*this.m[0]+e*this.m[1]+this.m[2],t.y=i*this.m[3]+e*this.m[4]+this.m[5],t},transformArr:function(t,i){var e=t[0],n=t[1];return i[0]=e*this.m[0]+n*this.m[1]+this.m[2],i[1]=e*this.m[3]+n*this.m[4]+this.m[5],i},transformX:function(t,i){return t*this.m[0]+i*this.m[1]+this.m[2]},transformY:function(t,i){return t*this.m[3]+i*this.m[4]+this.m[5]},release:function(){return e.matrices2d.push(this),null},setContextTransform:function(t){var i=this.m;t.transform(i[0],i[3],i[1],i[4],i[2],i[5])}}),e};!function(){for(var t=0,i=["ms","moz","webkit","o"],e=0;e<i.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[i[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i){var e=(new Date).getTime(),n=Math.max(0,16-(e-t)),s=window.setTimeout(function(){i(e+n)},n);return t=e+n,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),Quintus["2D"]=function(t){t.component("viewport",{added:function(){this.entity.on("prerender",this,"prerender"),this.entity.on("render",this,"postrender"),this.x=0,this.y=0,this.offsetX=0,this.offsetY=0,this.centerX=t.width/2,this.centerY=t.height/2,this.scale=1},extend:{follow:function(t,i,e){this.off("poststep",this.viewport,"follow"),this.viewport.directions=i||{x:!0,y:!0},this.viewport.following=t,this.viewport.boundingBox=e,this.on("poststep",this.viewport,"follow"),this.viewport.follow(!0)},unfollow:function(){this.off("poststep",this.viewport,"follow")},centerOn:function(t,i){this.viewport.centerOn(t,i)},moveTo:function(t,i){return this.viewport.moveTo(t,i)}},follow:function(i){var e=t._isFunction(this.directions.x)?this.directions.x(this.following):this.directions.x,n=t._isFunction(this.directions.y)?this.directions.y(this.following):this.directions.y;this[i===!0?"centerOn":"softCenterOn"](e?this.following.p.x+this.following.p.w/2-this.offsetX:void 0,n?this.following.p.y+this.following.p.h/2-this.offsetY:void 0)},offset:function(t,i){this.offsetX=t,this.offsetY=i},softCenterOn:function(i,e){if(void 0!==i){var n=(i-t.width/2/this.scale-this.x)/3;this.boundingBox?this.x+n<this.boundingBox.minX?this.x=this.boundingBox.minX/this.scale:this.x+n>(this.boundingBox.maxX-t.width)/this.scale?this.x=(this.boundingBox.maxX-t.width)/this.scale:this.x+=n:this.x+=n}if(void 0!==e){var s=(e-t.height/2/this.scale-this.y)/3;this.boundingBox?this.y+s<this.boundingBox.minY?this.y=this.boundingBox.minY/this.scale:this.y+s>(this.boundingBox.maxY-t.height)/this.scale?this.y=(this.boundingBox.maxY-t.height)/this.scale:this.y+=s:this.y+=s}},centerOn:function(i,e){void 0!==i&&(this.x=i-t.width/2/this.scale),void 0!==e&&(this.y=e-t.height/2/this.scale)},moveTo:function(t,i){return void 0!==t&&(this.x=t),void 0!==i&&(this.y=i),this.entity},prerender:function(){this.centerX=this.x+t.width/2/this.scale,this.centerY=this.y+t.height/2/this.scale,t.ctx.save(),t.ctx.translate(Math.floor(t.width/2),Math.floor(t.height/2)),t.ctx.scale(this.scale,this.scale),t.ctx.translate(-Math.floor(this.centerX),-Math.floor(this.centerY))},postrender:function(){t.ctx.restore()}}),t.Sprite.extend("TileLayer",{init:function(t){this._super(t,{tileW:32,tileH:32,blockTileW:10,blockTileH:10,type:1,renderAlways:!0}),this.p.dataAsset&&this.load(this.p.dataAsset),this.setDimensions(),this.blocks=[],this.p.blockW=this.p.tileW*this.p.blockTileW,this.p.blockH=this.p.tileH*this.p.blockTileH,this.colBounds={},this.directions=["top","left","right","bottom"],this.tileProperties={},this.collisionObject={p:{w:this.p.tileW,h:this.p.tileH,cx:this.p.tileW/2,cy:this.p.tileH/2}},this.tileCollisionObjects={},this.collisionNormal={separate:[]},this._generateCollisionObjects()},_generateCollisionObjects:function(){function i(t){return[t[0]*e.p.tileW-e.p.tileW/2,t[1]*e.p.tileH-e.p.tileH/2]}var e=this;if(this.sheet()&&this.sheet().frameProperties){var n=this.sheet().frameProperties;for(var s in n){var o=this.tileCollisionObjects[s]={p:t._clone(this.collisionObject.p)};t._extend(o.p,n[s]),o.p.points&&(o.p.points=t._map(o.p.points,i)),this.tileCollisionObjects[s]=o}}},load:function(i){var e,n=i.split("."),s=n[n.length-1].toLowerCase();if("json"!==s)throw"file type not supported";e=t._isString(i)?t.asset(i):i,this.p.tiles=e},setDimensions:function(){var t=this.p.tiles;t&&(this.p.rows=t.length,this.p.cols=t[0].length,this.p.w=this.p.cols*this.p.tileW,this.p.h=this.p.rows*this.p.tileH)},getTile:function(t,i){return this.p.tiles[i]&&this.p.tiles[i][t]},getTileProperty:function(t,i){return void 0!==this.tileProperties[t]?this.tileProperties[t][i]:void 0},getTileProperties:function(t){return void 0!==this.tileProperties[t]?this.tileProperties[t]:{}},getTilePropertyAt:function(t,i,e){return this.getTileProperty(this.getTile(t,i),e)},getTilePropertiesAt:function(t,i){return this.getTileProperties(this.getTile(t,i))},tileHasProperty:function(t,i){return void 0!==this.getTileProperty(t,i)},setTile:function(t,i,e){var n=this.p,s=Math.floor(t/n.blockTileW),o=Math.floor(i/n.blockTileH);t>=0&&t<this.p.cols&&i>=0&&i<this.p.rows&&(this.p.tiles[i][t]=e,this.blocks[o]&&(this.blocks[o][s]=null))},tilePresent:function(t,i){return this.p.tiles[i]&&this.collidableTile(this.p.tiles[i][t])},drawableTile:function(t){return t>0},collidableTile:function(t){return t>0},getCollisionObject:function(t,i){var e,n=this.p,s=this.getTile(t,i);return e=void 0!==this.tileCollisionObjects[s]?this.tileCollisionObjects[s]:this.collisionObject,e.p.x=t*n.tileW+n.x+n.tileW/2,e.p.y=i*n.tileH+n.y+n.tileH/2,e},collide:function(i){var e,n,s=this.p,o=i.c||i.p,r=Math.floor((o.x-o.cx-s.x)/s.tileW),a=Math.floor((o.y-o.cy-s.y)/s.tileH),h=Math.ceil((o.x-o.cx+o.w-s.x)/s.tileW),l=Math.ceil((o.y-o.cy+o.h-s.y)/s.tileH),c=this.collisionNormal;c.collided=!1;for(var u=a;l>=u;u++)for(var p=r;h>=p;p++)this.tilePresent(p,u)&&(n=this.getCollisionObject(p,u),e=t.collision(i,n),e&&e.magnitude>0&&(n.p.sensor?(n.tile=this.getTile(p,u),i.trigger&&i.trigger("sensor.tile",n)):(!c.collided||c.magnitude<e.magnitude)&&(c.collided=!0,c.separate[0]=e.separate[0],c.separate[1]=e.separate[1],c.magnitude=e.magnitude,c.distance=e.distance,c.normalX=e.normalX,c.normalY=e.normalY,c.tileX=p,c.tileY=u,c.tile=this.getTile(p,u),void 0!==i.p.collisions&&i.p.collisions.push(c))));return c.collided?c:!1},prerenderBlock:function(t,i){var e=this.p,n=e.tiles,s=this.sheet(),o=t*e.blockTileW,r=i*e.blockTileH;if(!(0>o||o>=this.p.cols||0>r||r>=this.p.rows)){var a=document.createElement("canvas"),h=a.getContext("2d");a.width=e.blockW,a.height=e.blockH,this.blocks[i]=this.blocks[i]||{},this.blocks[i][t]=a;for(var l=0;l<e.blockTileH;l++)if(n[l+r])for(var c=0;c<e.blockTileW;c++)this.drawableTile(n[l+r][c+o])&&s.draw(h,c*e.tileW,l*e.tileH,n[l+r][c+o])}},drawBlock:function(t,i,e){var n=this.p,s=Math.floor(i*n.blockW+n.x),o=Math.floor(e*n.blockH+n.y);this.blocks[e]&&this.blocks[e][i]||this.prerenderBlock(i,e),this.blocks[e]&&this.blocks[e][i]&&t.drawImage(this.blocks[e][i],s,o)},draw:function(i){for(var e=this.p,n=this.stage.viewport,s=n?n.scale:1,o=n?n.x:0,r=n?n.y:0,a=t.width/s,h=t.height/s,l=Math.floor((o-e.x)/e.blockW),c=Math.floor((r-e.y)/e.blockH),u=Math.floor((o+a-e.x)/e.blockW),p=Math.floor((r+h-e.y)/e.blockH),d=c;p>=d;d++)for(var f=l;u>=f;f++)this.drawBlock(i,f,d)}}),t.gravityY=9.8*100,t.gravityX=0,t.component("2d",{added:function(){var i=this.entity;t._defaults(i.p,{vx:0,vy:0,ax:0,ay:0,gravity:1,collisionMask:t.SPRITE_DEFAULT}),i.on("step",this,"step"),i.on("hit",this,"collision")},collision:function(t){var i=this.entity,e=i.p;if(t.obj.p&&t.obj.p.sensor)return void t.obj.trigger("sensor",i);t.impact=0;var n=Math.abs(e.vx),s=Math.abs(e.vy);e.x-=t.separate[0],e.y-=t.separate[1],t.normalY<-.3&&(!e.skipCollide&&e.vy>0&&(e.vy=0),t.impact=s,i.trigger("bump.bottom",t)),t.normalY>.3&&(!e.skipCollide&&e.vy<0&&(e.vy=0),t.impact=s,i.trigger("bump.top",t)),t.normalX<-.3&&(!e.skipCollide&&e.vx>0&&(e.vx=0),t.impact=n,i.trigger("bump.right",t)),t.normalX>.3&&(!e.skipCollide&&e.vx<0&&(e.vx=0),t.impact=n,i.trigger("bump.left",t))},step:function(i){for(var e=this.entity.p,n=i;n>0;)i=Math.min(1/30,n),e.vx+=e.ax*i+(void 0===e.gravityX?t.gravityX:e.gravityX)*i*e.gravity,e.vy+=e.ay*i+(void 0===e.gravityY?t.gravityY:e.gravityY)*i*e.gravity,e.x+=e.vx*i,e.y+=e.vy*i,this.entity.stage.collide(this.entity),n-=i}}),t.component("aiBounce",{added:function(){this.entity.on("bump.right",this,"goLeft"),this.entity.on("bump.left",this,"goRight")},goLeft:function(t){this.entity.p.vx=-t.impact,this.entity.p.flip="right"===this.entity.p.defaultDirection?"x":!1},goRight:function(t){this.entity.p.vx=t.impact,this.entity.p.flip="left"===this.entity.p.defaultDirection?"x":!1}})},Quintus.Anim=function(t){t._animations={},t.animations=function(i,e){t._animations[i]||(t._animations[i]={}),t._extend(t._animations[i],e)},t.animation=function(i,e){return t._animations[i]&&t._animations[i][e]},t.component("animation",{added:function(){var t=this.entity.p;t.animation=null,t.animationPriority=-1,t.animationFrame=0,t.animationTime=0,this.entity.on("step",this,"step")},extend:{play:function(t,i,e){this.animation.play(t,i,e)}},step:function(i){var e=this.entity,n=e.p;if(n.animation){var s=t.animation(n.sprite,n.animation),o=s.rate||n.rate,r=0;if(n.animationTime+=i,n.animationChanged?n.animationChanged=!1:(n.animationTime+=i,n.animationTime>o&&(r=Math.floor(n.animationTime/o),n.animationTime-=r*o,n.animationFrame+=r)),r>0){if(n.animationFrame>=s.frames.length){if(s.loop===!1||s.next)return n.animationFrame=s.frames.length-1,e.trigger("animEnd"),e.trigger("animEnd."+n.animation),n.animation=null,n.animationPriority=-1,s.trigger&&e.trigger(s.trigger,s.triggerData),void(s.next&&this.play(s.next,s.nextPriority));e.trigger("animLoop"),e.trigger("animLoop."+n.animation),n.animationFrame=n.animationFrame%s.frames.length}e.trigger("animFrame")}n.sheet=s.sheet||n.sheet,n.frame=s.frames[n.animationFrame],s.hasOwnProperty("flip")&&(n.flip=s.flip)}},play:function(t,i,e){var n=this.entity,s=n.p;i=i||0,t!==s.animation&&i>=s.animationPriority&&(void 0===e&&(e=!0),s.animation=t,e&&(s.animationChanged=!0,s.animationTime=0,s.animationFrame=0),s.animationPriority=i,n.trigger("anim"),n.trigger("anim."+s.animation))}}),t.Sprite.extend("Repeater",{init:function(i){this._super(t._defaults(i,{speedX:1,speedY:1,repeatY:!0,repeatX:!0,renderAlways:!0,type:0})),this.p.repeatW=this.p.repeatW||this.p.w,this.p.repeatH=this.p.repeatH||this.p.h},draw:function(i){var e,n,s,o=this.p,r=this.asset(),a=this.sheet(),h=this.stage.viewport?this.stage.viewport.scale:1,l=Math.floor(this.stage.viewport?this.stage.viewport.x:0),c=Math.floor(this.stage.viewport?this.stage.viewport.y:0),u=Math.floor(o.x+l*this.p.speedX),p=Math.floor(o.y+c*this.p.speedY);for(o.repeatX?(e=-u%o.repeatW,e>0&&(e-=o.repeatW)):e=o.x-l,o.repeatY?(n=-p%o.repeatH,n>0&&(n-=o.repeatH)):n=o.y-c,s=e;n<t.height/h;){for(e=s;e<t.width/h&&(a?a.draw(i,e+l,n+c,o.frame):i.drawImage(r,e+l,n+c),e+=o.repeatW,o.repeatX););if(n+=o.repeatH,!o.repeatY)break}}}),t.Tween=t.Class.extend({init:function(i,e,n,s,o){t._isObject(s)&&(o=s,s=t.Easing.Linear),t._isObject(n)&&(o=n,n=1),this.entity=i,this.duration=n||1,this.time=0,this.options=o||{},this.delay=this.options.delay||0,this.easing=s||this.options.easing||t.Easing.Linear,this.startFrame=t._loopFrame+1,this.properties=e,this.start={},this.diff={}},step:function(i){var e;if(this.startFrame>t._loopFrame)return!0;if(this.delay>=i)return this.delay-=i,!0;if(this.delay>0&&(i-=this.delay,this.delay=0),0===this.time){var n=this.entity,s=this.properties;this.p=n instanceof t.Stage?n.viewport:n.p;for(e in s)this.start[e]=this.p[e],t._isUndefined(this.start[e])||(this.diff[e]=s[e]-this.start[e])}this.time+=i;var o=Math.min(1,this.time/this.duration),r=this.easing(o);for(e in this.start)t._isUndefined(this.p[e])||(this.p[e]=this.start[e]+this.diff[e]*r);return o>=1&&this.options.callback&&this.options.callback.apply(this.entity),1>o}}),t.Easing={Linear:function(t){return t},Quadratic:{In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}}},t.component("tween",{added:function(){this._tweens=[],this.entity.on("step",this,"step")},extend:{animate:function(i,e,n,s){return this.tween._tweens.push(new t.Tween(this,i,e,n,s)),this},chain:function(i,e,n,s){t._isObject(n)&&(s=n,n=t.Easing.Linear);var o=this.tween._tweens.length;if(o>0){var r=this.tween._tweens[o-1];s=s||{},s.delay=r.duration-r.time+r.delay}return this.animate(i,e,n,s),this},stop:function(){return this.tween._tweens.length=0,this}},step:function(t){for(var i=0;i<this._tweens.length;i++)this._tweens[i].step(t)||(this._tweens.splice(i,1),i--)}})},Quintus.Audio=function(t){t.audio={channels:[],channelMax:t.options.channelMax||10,active:{},play:function(){}},t.hasWebAudio="undefined"!=typeof AudioContext||"undefined"!=typeof webkitAudioContext,t.hasWebAudio&&(t.audioContext="undefined"!=typeof AudioContext?new AudioContext:new window.webkitAudioContext),t.enableSound=function(){return t.hasWebAudio?t.audio.enableWebAudioSound():t.audio.enableHTML5Sound(),t},t.audio.enableWebAudioSound=function(){t.audio.type="WebAudio",t.audio.soundID=0,t.audio.playingSounds={},t.audio.removeSound=function(i){delete t.audio.playingSounds[i]},t.audio.play=function(i,e){var n=(new Date).getTime();if(!(t.audio.active[i]&&t.audio.active[i]>n)){e&&e.debounce?t.audio.active[i]=n+e.debounce:delete t.audio.active[i];var s=t.audio.soundID++,o=t.audioContext.createBufferSource();o.buffer=t.asset(i),o.connect(t.audioContext.destination),e&&e.loop?o.loop=!0:setTimeout(function(){t.audio.removeSound(s)},1e3*o.buffer.duration),o.assetName=i,o.start?o.start(0):o.noteOn(0),t.audio.playingSounds[s]=o}},t.audio.stop=function(i){for(var e in t.audio.playingSounds){var n=t.audio.playingSounds[e];i&&i!==n.assetName||(n.stop?n.stop(0):n.noteOff(0))}}},t.audio.enableHTML5Sound=function(){t.audio.type="HTML5";for(var i=0;i<t.audio.channelMax;i++)t.audio.channels[i]={},t.audio.channels[i].channel=new Audio,t.audio.channels[i].finished=-1;t.audio.play=function(i,e){var n=(new Date).getTime();if(!(t.audio.active[i]&&t.audio.active[i]>n)){e&&e.debounce?t.audio.active[i]=n+e.debounce:delete t.audio.active[i];for(var s=0;s<t.audio.channels.length;s++)if(!t.audio.channels[s].loop&&t.audio.channels[s].finished<n){t.audio.channels[s].channel.src=t.asset(i).src,e&&e.loop?(t.audio.channels[s].loop=!0,t.audio.channels[s].channel.loop=!0):t.audio.channels[s].finished=n+1e3*t.asset(i).duration,t.audio.channels[s].channel.load(),t.audio.channels[s].channel.play();break}}},t.audio.stop=function(i){for(var e=i?t.asset(i).src:null,n=(new Date).getTime(),s=0;s<t.audio.channels.length;s++)e&&t.audio.channels[s].channel.src!==e||!(t.audio.channels[s].loop||t.audio.channels[s].finished>=n)||(t.audio.channels[s].channel.pause(),t.audio.channels[s].loop=!1)}}},Quintus.Input=function(t){var i=t.KEY_NAMES={LEFT:37,RIGHT:39,UP:38,DOWN:40,SPACE:32,Z:90,X:88,ENTER:13,ESC:27,P:80,S:83},e={LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down",SPACE:"fire",Z:"fire",X:"action",ENTER:"confirm",ESC:"esc",P:"P",S:"S"},n=[["left","<"],["right",">"],[],["action","b"],["fire","a"]],s=["up","right","down","left"];t.inputs={},t.joypad={};var o=!!("ontouchstart"in window);t.canvasToStageX=function(i,e){return i=i/t.cssWidth*t.width,e.viewport&&(i/=e.viewport.scale,i+=e.viewport.x),i},t.canvasToStageY=function(i,e){return i=i/t.cssWidth*t.width,e.viewport&&(i/=e.viewport.scale,i+=e.viewport.y),i},t.InputSystem=t.Evented.extend({keys:{},keypad:{},keyboardEnabled:!1,touchEnabled:!1,joypadEnabled:!1,bindKey:function(e,n){t.input.keys[i[e]||e]=n},enableKeyboard:function(){return this.keyboardEnabled?!1:(t.el.tabIndex=0,t.el.style.outline=0,t.el.addEventListener("keydown",function(i){if(t.input.keys[i.keyCode]){var e=t.input.keys[i.keyCode];t.inputs[e]=!0,t.input.trigger(e),t.input.trigger("keydown",i.keyCode)}i.preventDefault()},!1),t.el.addEventListener("keyup",function(i){if(t.input.keys[i.keyCode]){var e=t.input.keys[i.keyCode];t.inputs[e]=!1,t.input.trigger(e+"Up"),t.input.trigger("keyup",i.keyCode)}i.preventDefault()},!1),t.options.autoFocus&&t.el.focus(),void(this.keyboardEnabled=!0))},keyboardControls:function(i){i=i||e,t._each(i,function(t,i){this.bindKey(i,t)},t.input),this.enableKeyboard()},_containerOffset:function(){t.input.offsetX=0,t.input.offsetY=0;var i=t.el;do t.input.offsetX+=i.offsetLeft,t.input.offsetY+=i.offsetTop;while(i=i.offsetParent)},touchLocation:function(i){var e,n,s=(t.el,i.offsetX),o=i.offsetY;return(t._isUndefined(s)||t._isUndefined(o))&&(s=i.layerX,o=i.layerY),(t._isUndefined(s)||t._isUndefined(o))&&(void 0===t.input.offsetX&&t.input._containerOffset(),s=i.pageX-t.input.offsetX,o=i.pageY-t.input.offsetY),e=t.width*s/t.cssWidth,n=t.height*o/t.cssHeight,{x:e,y:n}},touchControls:function(i){function e(e){for(var n=t.input.touchLocation(e),s=0,o=i.controls.length;o>s;s++)if(n.x<i.unit*(s+1)&&n.y>t.height-i.unit)return i.controls[s][0]}function s(n){var s,o,r,a,h,l={};for(s=0,o=i.controls.length;o>s;s++)h=i.controls[s][0],t.inputs[h]&&(l[h]=!0),t.inputs[h]=!1;var c=n.touches?n.touches:[n];for(s=0,o=c.length;o>s;s++)r=c[s],a=e(r),a&&(t.inputs[a]=!0,l[a]?delete l[a]:t.input.trigger(a));for(h in l)t.input.trigger(h+"Up");return null}return this.touchEnabled?!1:o?(t.input.keypad=i=t._extend({left:0,gutter:10,controls:n,width:t.width,bottom:t.height},i),i.unit=i.width/i.controls.length,i.size=i.unit-2*i.gutter,this.touchDispatchHandler=function(t){s(t),t.preventDefault()},t._each(["touchstart","touchend","touchmove","touchcancel"],function(i){t.el.addEventListener(i,this.touchDispatchHandler)},this),void(this.touchEnabled=!0)):!1},disableTouchControls:function(){t._each(["touchstart","touchend","touchmove","touchcancel"],function(i){t.el.removeEventListener(i,this.touchDispatchHandler)},this),t.el.removeEventListener("touchstart",this.joypadStart),t.el.removeEventListener("touchmove",this.joypadMove),t.el.removeEventListener("touchend",this.joypadEnd),t.el.removeEventListener("touchcancel",this.joypadEnd),this.touchEnabled=!1;for(var i in t.inputs)t.inputs[i]=!1},joypadControls:function(i){if(this.joypadEnabled)return!1;if(!o)return!1;var e=t.joypad=t._defaults(i||{},{size:50,trigger:20,center:25,color:"#CCC",background:"#000",alpha:.5,zone:t.width/2,joypadTouch:null,inputs:s,triggers:[]});this.joypadStart=function(i){if(null===e.joypadTouch){var n=i.changedTouches[0],s=t.input.touchLocation(n);s.x<e.zone&&(e.joypadTouch=n.identifier,e.centerX=s.x,e.centerY=s.y,e.x=null,e.y=null)}},this.joypadMove=function(i){if(null!==e.joypadTouch)for(var n=i,s=0,o=n.changedTouches.length;o>s;s++){var r=n.changedTouches[s];if(r.identifier===e.joypadTouch){var a=t.input.touchLocation(r),h=a.x-e.centerX,l=a.y-e.centerY,c=Math.sqrt(h*h+l*l),u=Math.max(1,c/e.size),p=Math.atan2(h,l);u>1&&(h/=u,l/=u,c/=u);for(var d=[l<-e.trigger,h>e.trigger,l>e.trigger,h<-e.trigger],f=0;f<d.length;f++){var g=e.inputs[f];
d[f]?(t.inputs[g]=!0,e.triggers[f]||t.input.trigger(g)):(t.inputs[g]=!1,e.triggers[f]&&t.input.trigger(g+"Up"))}t._extend(e,{dx:h,dy:l,x:e.centerX+h,y:e.centerY+l,dist:c,ang:p,triggers:d});break}}i.preventDefault()},this.joypadEnd=function(i){var n=i;if(null!==e.joypadTouch)for(var s=0,o=n.changedTouches.length;o>s;s++){var r=n.changedTouches[s];if(r.identifier===e.joypadTouch){for(var a=0;a<e.triggers.length;a++){var h=e.inputs[a];t.inputs[h]=!1,e.triggers[a]&&t.input.trigger(h+"Up")}e.joypadTouch=null;break}}i.preventDefault()},t.el.addEventListener("touchstart",this.joypadStart),t.el.addEventListener("touchmove",this.joypadMove),t.el.addEventListener("touchend",this.joypadEnd),t.el.addEventListener("touchcancel",this.joypadEnd),this.joypadEnabled=!0},mouseControls:function(i){i=i||{};var e=i.stageNum||0,n=i.mouseX||"mouseX",s=i.mouseY||"mouseY",o=i.cursor||"off",r={};"on"!==o&&(t.el.style.cursor="off"===o?"none":o),t.inputs[n]=0,t.inputs[s]=0,t._mouseMove=function(i){i.preventDefault();var o=i.touches?i.touches[0]:i,a=(t.el,o.offsetX),h=o.offsetY,l=t.stage(e);(t._isUndefined(a)||t._isUndefined(h))&&(a=o.layerX,h=o.layerY),(t._isUndefined(a)||t._isUndefined(h))&&(void 0===t.input.offsetX&&t.input._containerOffset(),a=o.pageX-t.input.offsetX,h=o.pageY-t.input.offsetY),l&&(r.x=t.canvasToStageX(a,l),r.y=t.canvasToStageY(h,l),t.inputs[n]=r.x,t.inputs[s]=r.y,t.input.trigger("mouseMove",r))},t.el.addEventListener("mousemove",t._mouseMove,!0),t.el.addEventListener("touchstart",t._mouseMove,!0),t.el.addEventListener("touchmove",t._mouseMove,!0)},disableMouseControls:function(){t._mouseMove&&(t.el.removeEventListener("mousemove",t._mouseMove,!0),t.el.style.cursor="inherit",t._mouseMove=null)},drawButtons:function(){var i=t.input.keypad,e=t.ctx;e.save(),e.textAlign="center",e.textBaseline="middle";for(var n=0;n<i.controls.length;n++){var s=i.controls[n];if(s[0]){e.font="bold "+i.size/2+"px arial";var o=i.left+n*i.unit+i.gutter,r=i.bottom-i.unit,a=t.inputs[s[0]];e.fillStyle=i.color||"#FFFFFF",e.globalAlpha=a?1:.5,e.fillRect(o,r,i.size,i.size),e.fillStyle=i.text||"#000000",e.fillText(s[1],o+i.size/2,r+i.size/2)}}e.restore()},drawCircle:function(i,e,n,s){var o=t.ctx,r=t.joypad;o.save(),o.beginPath(),o.globalAlpha=r.alpha,o.fillStyle=n,o.arc(i,e,s,0,2*Math.PI,!0),o.closePath(),o.fill(),o.restore()},drawJoypad:function(){var i=t.joypad;null!==i.joypadTouch&&(t.input.drawCircle(i.centerX,i.centerY,i.background,i.size),null!==i.x&&t.input.drawCircle(i.x,i.y,i.color,i.center))},drawCanvas:function(){this.touchEnabled&&this.drawButtons(),this.joypadEnabled&&this.drawJoypad()}}),t.input=new t.InputSystem,t.controls=function(i){return t.input.keyboardControls(),i?(t.input.touchControls({controls:[[],[],[],["action","b"],["fire","a"]]}),t.input.joypadControls()):t.input.touchControls(),t},t.component("platformerControls",{defaults:{speed:200,jumpSpeed:-300,collisions:[]},added:function(){var i=this.entity.p;t._defaults(i,this.defaults),this.entity.on("step",this,"step"),this.entity.on("bump.bottom",this,"landed"),i.landed=0,i.direction="right"},landed:function(){var t=this.entity.p;t.landed=.2},step:function(i){var e=this.entity.p;if(void 0===e.ignoreControls||!e.ignoreControls){var n=null;if(void 0!==e.collisions&&e.collisions.length>0&&(t.inputs.left||t.inputs.right||e.landed>0)){if(1===e.collisions.length)n=e.collisions[0];else{n=null;for(var s=0;s<e.collisions.length;s++)e.collisions[s].normalY<0&&(n=e.collisions[s])}null!==n&&n.normalY>-.3&&n.normalY<.3&&(n=null)}t.inputs.left?(e.direction="left",n&&e.landed>0?(e.vx=e.speed*n.normalY,e.vy=-e.speed*n.normalX):e.vx=-e.speed):t.inputs.right?(e.direction="right",n&&e.landed>0?(e.vx=-e.speed*n.normalY,e.vy=e.speed*n.normalX):e.vx=e.speed):(e.vx=0,n&&e.landed>0&&(e.vy=0)),e.landed>0&&(t.inputs.up||t.inputs.action)&&!e.jumping?(e.vy=e.jumpSpeed,e.landed=-i,e.jumping=!0):(t.inputs.up||t.inputs.action)&&(this.entity.trigger("jump",this.entity),e.jumping=!0),!e.jumping||t.inputs.up||t.inputs.action||(e.jumping=!1,this.entity.trigger("jumped",this.entity),e.vy<e.jumpSpeed/3&&(e.vy=e.jumpSpeed/3))}e.landed-=i}}),t.component("stepControls",{added:function(){var t=this.entity.p;t.stepDistance||(t.stepDistance=32),t.stepDelay||(t.stepDelay=.2),t.stepWait=0,this.entity.on("step",this,"step"),this.entity.on("hit",this,"collision")},collision:function(){var t=this.entity.p;t.stepping&&(t.stepping=!1,t.x=t.origX,t.y=t.origY)},step:function(i){var e=this.entity.p;e.stepWait-=i,e.stepping&&(e.x+=e.diffX*i/e.stepDelay,e.y+=e.diffY*i/e.stepDelay),e.stepWait>0||(e.stepping&&(e.x=e.destX,e.y=e.destY),e.stepping=!1,e.diffX=0,e.diffY=0,t.inputs.left?e.diffX=-e.stepDistance:t.inputs.right&&(e.diffX=e.stepDistance),t.inputs.up?e.diffY=-e.stepDistance:t.inputs.down&&(e.diffY=e.stepDistance),(e.diffY||e.diffX)&&(e.stepping=!0,e.origX=e.x,e.origY=e.y,e.destX=e.x+e.diffX,e.destY=e.y+e.diffY,e.stepWait=e.stepDelay))}})},Quintus.Scenes=function(t){t.scenes={},t.stages=[],t.Class.extend("Scene",{init:function(t,i){this.opts=i||{},this.sceneFunc=t}}),t.scene=function(i,e,n){return void 0===e?t.scenes[i]:(t._isFunction(e)&&(e=new t.Scene(e,n),e.name=i),t.scenes[i]=e,e)},t._nullContainer={c:{x:0,y:0,angle:0,scale:1},matrix:t.matrix2d()},t.collision=function(){function i(t,i){var e=t[i],n=t[i+1]||t[0];o=-(n[1]-e[1]),r=n[0]-e[0];var s=Math.sqrt(o*o+r*r);s>0&&(o/=s,r/=s)}function e(t){return o*t[0]+r*t[1]}function n(t,n,s){var c,u,p,d,f,g,m,v,y,x,w,b,_,T,S=Number.POSITIVE_INFINITY,E=!1,C=s?l:h;for(a[0]=0,a[1]=0,t.c?_=t.c.points:(_=t.p.points,a[0]+=t.p.x,a[1]+=t.p.y),n.c?T=n.c.points:(T=n.p.points,a[0]+=-n.p.x,a[1]+=-n.p.y),t=t.p,n=n.p,y=0;y<_.length;y++){for(i(_,y),c=e(_[0]),u=c,x=1;x<_.length;x++)v=e(_[x]),c>v&&(c=v),v>u&&(u=v);for(p=e(T[0]),d=p,x=1;x<T.length;x++)v=e(T[x]),p>v&&(p=v),v>d&&(d=v);if(m=e(a),c+=m,u+=m,f=c-d,g=p-u,f>0||g>0)return null;w=-1*(d-c),s&&(w*=-1),b=Math.abs(w),S>b&&(C.distance=w,C.magnitude=b,C.normalX=o,C.normalY=r,C.distance>0&&(C.distance*=-1,C.normalX*=-1,C.normalY*=-1),E=!0,S=b)}return E?C:null}function s(i,e){var s,o,r;return i.p.points||t._generatePoints(i),e.p.points||t._generatePoints(e),(s=n(i,e))?(o=n(e,i,!0))?(r=o.magnitude<s.magnitude?o:s,0===r.magnitude?!1:(r.separate[0]=r.distance*r.normalX,r.separate[1]=r.distance*r.normalY,r)):!1:!1}var o,r,a=[0,0],h={separate:[]},l={separate:[]};return s}(),t.overlap=function(t,i){var e=t.c||t.p||t,n=i.c||i.p||i,s=e.x-(e.cx||0),o=e.y-(e.cy||0),r=n.x-(n.cx||0),a=n.y-(n.cy||0);return!(o+e.h<a||o>a+n.h||s+e.w<r||s>r+n.w)},t.Stage=t.GameObject.extend({defaults:{sort:!1,gridW:400,gridH:400,x:0,y:0},init:function(i,e){this.scene=i,this.items=[],this.lists={},this.index={},this.removeList=[],this.grid={},this._collisionLayers=[],this.time=0,this.defaults.w=t.width,this.defaults.h=t.height,this.options=t._extend({},this.defaults),this.scene&&t._extend(this.options,i.opts),e&&t._extend(this.options,e),this.options.sort&&!t._isFunction(this.options.sort)&&(this.options.sort=function(t,i){return(t.p&&t.p.z||-1)-(i.p&&i.p.z||-1)})},destroyed:function(){this.invoke("debind"),this.trigger("destroyed")},loadScene:function(){this.scene&&this.scene.sceneFunc(this)},loadAssets:function(i){for(var e=t._isArray(i)?i:t.asset(i),n=0;n<e.length;n++){var s=e[n][0],o=e[n][1];this.insert(new t[s](o))}},each:function(t){for(var i=0,e=this.items.length;e>i;i++)t.call(this.items[i],arguments[1],arguments[2])},invoke:function(t){for(var i=0,e=this.items.length;e>i;i++)this.items[i][t].call(this.items[i],arguments[1],arguments[2])},detect:function(t){for(var i=this.items.length-1;i>=0;i--)if(t.call(this.items[i],arguments[1],arguments[2],arguments[3]))return this.items[i];return!1},identify:function(t){for(var i,e=this.items.length-1;e>=0;e--)if(i=t.call(this.items[e],arguments[1],arguments[2],arguments[3]))return i;return!1},find:function(t){return this.index[t]},addToLists:function(t,i){for(var e=0;e<t.length;e++)this.addToList(t[e],i)},addToList:function(t,i){this.lists[t]||(this.lists[t]=[]),this.lists[t].push(i)},removeFromLists:function(t,i){for(var e=0;e<t.length;e++)this.removeFromList(t[e],i)},removeFromList:function(t,i){var e=this.lists[t].indexOf(i);-1!==e&&this.lists[t].splice(e,1)},insert:function(i,e){return this.items.push(i),i.stage=this,i.container=e,e&&e.children.push(i),i.grid={},t._generatePoints(i),t._generateCollisionPoints(i),i.className&&this.addToList(i.className,i),i.activeComponents&&this.addToLists(i.activeComponents,i),i.p&&(this.index[i.p.id]=i),this.trigger("inserted",i),i.trigger("inserted",this),this.regrid(i),i},remove:function(t){this.delGrid(t),this.removeList.push(t)},forceRemove:function(t){var i=this.items.indexOf(t);if(-1!==i){if(this.items.splice(i,1),t.className&&this.removeFromList(t.className,t),t.activeComponents&&this.removeFromLists(t.activeComponents,t),t.container){var e=t.container.children.indexOf(t);-1!==e&&t.container.children.splice(e,1)}t.destroy&&t.destroy(),t.p.id&&delete this.index[t.p.id],this.trigger("removed",t)}},pause:function(){this.paused=!0},unpause:function(){this.paused=!1},_gridCellCheck:function(i,e,n,s){if(t._isUndefined(s)||s&i){var o=this.index[e];if(o&&o!==n&&t.overlap(n,o)){var r=t.collision(n,o);return r?(r.obj=o,r):!1}}},gridTest:function(i,e){for(var n,s,o=i.grid,r=o.Y1;r<=o.Y2;r++)if(this.grid[r])for(var a=o.X1;a<=o.X2;a++)if(n=this.grid[r][a],n&&(s=t._detect(n,this._gridCellCheck,this,i,e)))return s;return!1},collisionLayer:function(t){return this._collisionLayers.push(t),t.collisionLayer=!0,this.insert(t)},_collideCollisionLayer:function(t,i){for(var e,n=0,s=this._collisionLayers.length;s>n;n++){var o=this._collisionLayers[n];if(o.p.type&i&&(e=o.collide(t)))return e.obj=o,e}return!1},search:function(i,e){var n;return i.grid||this.regrid(i,i.stage!==this),e=t._isUndefined(e)?i.p&&i.p.collisionMask:e,n=this._collideCollisionLayer(i,e),n=n||this.gridTest(i,e)},_locateObj:{p:{x:0,y:0,cx:0,cy:0,w:1,h:1},grid:{}},locate:function(t,i,e){var n=null;return this._locateObj.p.x=t,this._locateObj.p.y=i,this.regrid(this._locateObj,!0),n=this._collideCollisionLayer(this._locateObj,e),n=n||this.gridTest(this._locateObj,e),n&&n.obj?n.obj:!1},collide:function(i,e){var n,s,o,r,a,h;for(t._isObject(e)?(o=e.collisionMask,r=e.maxCol,h=e.skipEvents):o=e,o=t._isUndefined(o)?i.p&&i.p.collisionMask:o,r=r||3,t._generateCollisionPoints(i),this.regrid(i),a=r;a>0&&(n=this._collideCollisionLayer(i,o));)h||(i.trigger("hit",n),i.trigger("hit.collision",n)),t._generateCollisionPoints(i),this.regrid(i),a--;for(a=r;a>0&&(s=this.gridTest(i,o));){if(i.trigger("hit",s),i.trigger("hit.sprite",s),!h){var l=s.obj;s.obj=i,s.normalX*=-1,s.normalY*=-1,s.distance=0,s.magnitude=0,s.separate[0]=0,s.separate[1]=0,l.trigger("hit",s),l.trigger("hit.sprite",s)}t._generateCollisionPoints(i),this.regrid(i),a--}return s||n},delGrid:function(t){for(var i=t.grid,e=i.Y1;e<=i.Y2;e++)if(this.grid[e])for(var n=i.X1;n<=i.X2;n++)this.grid[e][n]&&delete this.grid[e][n][t.p.id]},addGrid:function(t){for(var i=t.grid,e=i.Y1;e<=i.Y2;e++){this.grid[e]||(this.grid[e]={});for(var n=i.X1;n<=i.X2;n++)this.grid[e][n]||(this.grid[e][n]={}),this.grid[e][n][t.p.id]=t.p.type}},regrid:function(t,i){if(!t.collisionLayer){t.grid=t.grid||{};var e=t.c||t.p,n=Math.floor((e.x-e.cx)/this.options.gridW),s=Math.floor((e.y-e.cy)/this.options.gridH),o=Math.floor((e.x-e.cx+e.w)/this.options.gridW),r=Math.floor((e.y-e.cy+e.h)/this.options.gridH),a=t.grid;(a.X1!==n||a.X2!==o||a.Y1!==s||a.Y2!==r)&&(void 0!==a.X1&&this.delGrid(t),a.X1=n,a.X2=o,a.Y1=s,a.Y2=r,i||this.addGrid(t))}},markSprites:function(i,e){for(var n,s,o=this.viewport,r=o?o.scale:1,a=o?o.x:0,h=o?o.y:0,l=t.width/r,c=t.height/r,u=Math.floor(a/this.options.gridW),p=Math.floor(h/this.options.gridH),d=Math.floor((a+l)/this.options.gridW),f=Math.floor((h+c)/this.options.gridH),g=p;f>=g;g++)if(n=this.grid[g])for(var m=u;d>=m;m++)if(s=n[m])for(var v in s)this.index[v]&&(this.index[v].mark=e,this.index[v].container&&(this.index[v].container.mark=e))},updateSprites:function(i,e,n){for(var s,o=0,r=i.length;r>o;o++)s=i[o],(n||!s.p.visibleOnly||s.mark&&!(s.mark<this.time))&&(n||!s.container)&&(s.update(e),t._generateCollisionPoints(s),this.regrid(s))},step:function(t){if(this.paused)return!1;if(this.time+=t,this.markSprites(this.items,this.time),this.trigger("prestep",t),this.updateSprites(this.items,t),this.trigger("step",t),this.removeList.length>0){for(var i=0,e=this.removeList.length;e>i;i++)this.forceRemove(this.removeList[i]);this.removeList.length=0}this.trigger("poststep",t)},hide:function(){this.hidden=!0},show:function(){this.hidden=!1},stop:function(){this.hide(),this.pause()},start:function(){this.show(),this.unpause()},render:function(t){if(this.hidden)return!1;this.options.sort&&this.items.sort(this.options.sort),this.trigger("prerender",t),this.trigger("beforerender",t);for(var i=0,e=this.items.length;e>i;i++){var n=this.items[i];!n.container&&(n.p.renderAlways||n.mark>=this.time)&&n.render(t)}this.trigger("render",t),this.trigger("postrender",t)}}),t.activeStage=0,t.StageSelector=t.Class.extend({emptyList:[],init:function(t,i){this.stage=t,this.selector=i,this.items=this.stage.lists[this.selector]||this.emptyList,this.length=this.items.length},each:function(t){for(var i=0,e=this.items.length;e>i;i++)t.call(this.items[i],arguments[1],arguments[2]);return this},invoke:function(t){for(var i=0,e=this.items.length;e>i;i++)this.items[i][t].call(this.items[i],arguments[1],arguments[2]);return this},trigger:function(t,i){this.invoke("trigger",t,i)},destroy:function(){this.invoke("destroy")},detect:function(t){for(var i=0,e=this.items.length;e>i;i++)if(t.call(this.items[i],arguments[1],arguments[2]))return this.items[i];return!1},identify:function(t){for(var i=null,e=0,n=this.items.length;n>e;e++)if(i=t.call(this.items[e],arguments[1],arguments[2]))return i;return!1},_pObject:function(i){t._extend(this.p,i)},_pSingle:function(t,i){this.p[t]=i},set:function(t,i){return void 0===i?this.each(this._pObject,t):this.each(this._pSingle,t,i),this},at:function(t){return this.items[t]},first:function(){return this.items[0]},last:function(){return this.items[this.items.length-1]}}),t.select=function(i,e){return e=void 0===e?t.activeStage:e,e=t.stage(e),t._isNumber(i)?e.index[i]:new t.StageSelector(e,i)},t.stage=function(i){return i=void 0===i?t.activeStage:i,t.stages[i]},t.stageScene=function(i,e,n){t._isString(i)&&(i=t.scene(i)),t._isObject(e)&&(n=e,e=t._popProperty(n,"stage")||i&&i.opts.stage||0),n=t._clone(n);var s=t._popProperty(n,"stageClass")||i&&i.opts.stageClass||t.Stage;e=t._isUndefined(e)?i&&i.opts.stage||0:e,t.stages[e]&&t.stages[e].destroy(),t.activeStage=e;var o=t.stages[e]=new s(i,n);return o.options.asset&&o.loadAssets(o.options.asset),i&&o.loadScene(),t.activeStage=0,t.loop||t.gameLoop(t.stageGameLoop),o},t.stageGameLoop=function(i){var e,n,s;for(0>i&&(i=1/60),i>1/15&&(i=1/15),e=0,n=t.stages.length;n>e;e++)t.activeStage=e,s=t.stage(),s&&s.step(i);for(t.ctx&&t.clear(),e=0,n=t.stages.length;n>e;e++)t.activeStage=e,s=t.stage(),s&&s.render(t.ctx);t.activeStage=0,t.input&&t.ctx&&t.input.drawCanvas(t.ctx)},t.clearStage=function(i){t.stages[i]&&(t.stages[i].destroy(),t.stages[i]=null)},t.clearStages=function(){for(var i=0,e=t.stages.length;e>i;i++)t.stages[i]&&t.stages[i].destroy();t.stages.length=0}},Quintus.Sprites=function(t){return t.Class.extend("SpriteSheet",{init:function(i,e,n){if(!t.asset(e))throw"Invalid Asset:"+e;t._extend(this,{name:i,asset:e,w:t.asset(e).width,h:t.asset(e).height,tileW:64,tileH:64,sx:0,sy:0,spacingX:0,spacingY:0,frameProperties:{}}),n&&t._extend(this,n),this.tilew&&(this.tileW=this.tilew,delete this.tilew),this.tileh&&(this.tileH=this.tileh,delete this.tileh),this.cols=this.cols||Math.floor(this.w/(this.tileW+this.spacingX)),this.frames=this.cols*Math.floor(this.h/(this.tileH+this.spacingY))},fx:function(t){return Math.floor(t%this.cols*(this.tileW+this.spacingX)+this.sx)},fy:function(t){return Math.floor(Math.floor(t/this.cols)*(this.tileH+this.spacingY)+this.sy)},draw:function(i,e,n,s){i||(i=t.ctx),i.drawImage(t.asset(this.asset),this.fx(s),this.fy(s),this.tileW,this.tileH,Math.floor(e),Math.floor(n),this.tileW,this.tileH)}}),t.sheets={},t.sheet=function(i,e,n){return e?void(t.sheets[i]=new t.SpriteSheet(i,e,n)):t.sheets[i]},t.compileSheets=function(i,e){var n=t.asset(e);t._each(n,function(e,n){t.sheet(n,i,e)})},t.SPRITE_NONE=0,t.SPRITE_DEFAULT=1,t.SPRITE_PARTICLE=2,t.SPRITE_ACTIVE=4,t.SPRITE_FRIENDLY=8,t.SPRITE_ENEMY=16,t.SPRITE_POWERUP=32,t.SPRITE_UI=64,t.SPRITE_ALL=65535,t._generatePoints=function(t,i){if(!t.p.points||i){var e=t.p,n=e.w/2,s=e.h/2;e.points=[[-n,-s],[n,-s],[n,s],[-n,s]]}},t._generateCollisionPoints=function(i){if(i.matrix||i.refreshMatrix){i.c||(i.c={points:[]});var e=i.p,n=i.c;if(e.moved||n.origX!==e.x||n.origY!==e.y||n.origScale!==e.scale||n.origScale!==e.angle){n.origX=e.x,n.origY=e.y,n.origScale=e.scale,n.origAngle=e.angle,i.refreshMatrix();var s;if(!(i.container||e.scale&&1!==e.scale||0!==e.angle)){for(s=0;s<i.p.points.length;s++)i.c.points[s]=i.c.points[s]||[],i.c.points[s][0]=e.x+i.p.points[s][0],i.c.points[s][1]=e.y+i.p.points[s][1];return n.x=e.x,n.y=e.y,n.cx=e.cx,n.cy=e.cy,n.w=e.w,void(n.h=e.h)}var o=i.container||t._nullContainer;n.x=o.matrix.transformX(e.x,e.y),n.y=o.matrix.transformY(e.x,e.y),n.angle=e.angle+o.c.angle,n.scale=(o.c.scale||1)*(e.scale||1);var r=1/0,a=1/0,h=-1/0,l=-1/0;for(s=0;s<i.p.points.length;s++){i.c.points[s]||(i.c.points[s]=[]),i.matrix.transformArr(i.p.points[s],i.c.points[s]);var c=i.c.points[s][0],u=i.c.points[s][1];r>c&&(r=c),c>h&&(h=c),a>u&&(a=u),u>l&&(l=u)}r===h&&(h+=1),a===l&&(l+=1),n.cx=n.x-r,n.cy=n.y-a,n.w=h-r,n.h=l-a}}},t.GameObject.extend("Sprite",{init:function(i,e){this.p=t._extend({x:0,y:0,z:0,opacity:1,angle:0,frame:0,type:t.SPRITE_DEFAULT|t.SPRITE_ACTIVE,name:"",spriteProperties:{}},e),this.matrix=new t.Matrix2D,this.children=[],t._extend(this.p,i),this.size(),this.p.id=this.p.id||t._uniqueId(),this.refreshMatrix()},size:function(t){!t&&this.p.w&&this.p.h||(this.asset()?(this.p.w=this.asset().width,this.p.h=this.asset().height):this.sheet()&&(this.p.w=this.sheet().tileW,this.p.h=this.sheet().tileH)),this.p.cx=t||void 0===this.p.cx?this.p.w/2:this.p.cx,this.p.cy=t||void 0===this.p.cy?this.p.h/2:this.p.cy},asset:function(i,e){return i?(this.p.asset=i,void(e&&(this.size(!0),t._generatePoints(this,!0)))):t.asset(this.p.asset)},sheet:function(i,e){return i?(this.p.sheet=i,void(e&&(this.size(!0),t._generatePoints(this,!0)))):t.sheet(this.p.sheet)},hide:function(){this.p.hidden=!0},show:function(){this.p.hidden=!1},set:function(i){return t._extend(this.p,i),this},_sortChild:function(t,i){return(t.p&&t.p.z||-1)-(i.p&&i.p.z||-1)},_flipArgs:{x:[-1,1],y:[1,-1],xy:[-1,-1]},render:function(i){var e=this.p;e.hidden||(i||(i=t.ctx),this.trigger("predraw",i),i.save(),void 0!==this.p.opacity&&1!==this.p.opacity&&(i.globalAlpha=this.p.opacity),this.matrix.setContextTransform(i),this.p.flip&&i.scale.apply(i,this._flipArgs[this.p.flip]),this.trigger("beforedraw",i),this.draw(i),this.trigger("draw",i),i.restore(),this.p.sort&&this.children.sort(this._sortChild),t._invoke(this.children,"render",i),this.trigger("postdraw",i),t.debug&&this.debugRender(i))},center:function(){this.container?(this.p.x=this.container.p.w/2,this.p.y=this.container.p.h/2):(this.p.x=t.width/2,this.p.y=t.height/2)},draw:function(i){var e=this.p;e.sheet?this.sheet().draw(i,-e.cx,-e.cy,e.frame):e.asset?i.drawImage(t.asset(e.asset),-e.cx,-e.cy):e.color&&(i.fillStyle=e.color,i.fillRect(-e.cx,-e.cy,e.w,e.h))},debugRender:function(i){this.p.points||t._generatePoints(this),i.save(),this.matrix.setContextTransform(i),i.beginPath(),i.fillStyle=this.p.hit?"blue":"red",i.strokeStyle="#FF0000",i.fillStyle="rgba(0,0,0,0.5)",i.moveTo(this.p.points[0][0],this.p.points[0][1]);for(var e=0;e<this.p.points.length;e++)i.lineTo(this.p.points[e][0],this.p.points[e][1]);if(i.lineTo(this.p.points[0][0],this.p.points[0][1]),i.stroke(),t.debugFill&&i.fill(),i.restore(),this.c){var n=this.c;i.save(),i.globalAlpha=1,i.lineWidth=2,i.strokeStyle="#FF00FF",i.beginPath(),i.moveTo(n.x-n.cx,n.y-n.cy),i.lineTo(n.x-n.cx+n.w,n.y-n.cy),i.lineTo(n.x-n.cx+n.w,n.y-n.cy+n.h),i.lineTo(n.x-n.cx,n.y-n.cy+n.h),i.lineTo(n.x-n.cx,n.y-n.cy),i.stroke(),i.restore()}},update:function(t){this.trigger("prestep",t),this.step&&this.step(t),this.trigger("step",t),this.refreshMatrix(),this.stage&&this.children.length>0&&this.stage.updateSprites(this.children,t,!0),this.p.collisions&&(this.p.collisions=[])},refreshMatrix:function(){var t=this.p;this.matrix.identity(),this.container&&this.matrix.multiply(this.container.matrix),this.matrix.translate(t.x,t.y),t.scale&&this.matrix.scale(t.scale,t.scale),this.matrix.rotateDeg(t.angle)}}),t.Sprite.extend("MovingSprite",{init:function(i,e){this._super(t._extend({vx:0,vy:0,ax:0,ay:0},i),e)},step:function(t){var i=this.p;i.vx+=i.ax*t,i.vy+=i.ay*t,i.x+=i.vx*t,i.y+=i.vy*t}}),t},Quintus.TMX=function(t){function i(t,i){var e=t.getAttribute(i);return isNaN(e)?e:+e}function e(t){for(var e=t.querySelectorAll("property"),n={},s=0;s<e.length;s++){var o=e[s];n[i(o,"name")]=i(o,"value")}return n}t.assetTypes.tmx="TMX",t.loadAssetTMX=function(i,e,n,s){t.loadAssetOther(i,e,function(t,i){var e=new DOMParser,s=e.parseFromString(i,"application/xml");n(t,s)},s)},t._tmxExtractAssetName=function(t){var i=t.getAttribute("source"),e=i.split("/");return e[e.length-1]},t._tmxExtractSources=function(i){var e=i.querySelectorAll("[source]");return t._map(e,t._tmxExtractAssetName)},t.loadTMX=function(i,e,n){t._isString(i)&&(i=t._normalizeArg(i));var s=[];t._each(i,function(i){"tmx"===t._fileExtension(i)&&s.push(i)});var o=[];t.load(i,function(){t._each(s,function(i){var e=t._tmxExtractSources(t.asset(i));o=o.concat(e)}),o.length>0?t.load(o,e,n):e()})},t._tmxLoadTilesets=function(n,s){function o(t){var i=t.split(",");return[parseFloat(i[0]),parseFloat(i[1])]}for(var r=[],a=0;a<n.length;a++){for(var h=n[a],l=i(h,"name"),c=i(h,"firstgid"),u=t._tmxExtractAssetName(h.querySelector("image")),p={},d={tileW:i(h,"tilewidth"),tileH:i(h,"tileheight"),spacingX:i(h,"spacing"),spacingY:i(h,"spacing")},f=h.querySelectorAll("tile"),g=0;g<f.length;g++){var m=f[g],v=i(m,"id"),y=c+v,x=e(m);x.points&&(x.points=t._map(x.points.split(" "),o)),s[y]=x,p[v]=x}d.frameProperties=p,r.push([c,l]),t.sheet(l,u,d)}return r},t._tmxProcessImageLayer=function(i,n,s,o){var r=t._tmxExtractAssetName(o.querySelector("image")),a=e(o);a.asset=r,i.insert(new t.Repeater(a))},t._lookupGid=function(t,i){for(var e=0;i[e+1]&&t>=i[e+1][0];)e++;return i[e]},t._tmxProcessTileLayer=function(n,s,o,r){for(var a,h,l,c=r.querySelectorAll("tile"),u=i(r,"width"),p=i(r,"height"),d=[],f=0,g=0;p>g;g++){d[g]=[];for(var m=0;u>m;m++){var v=i(c[f],"gid");0===v?d[g].push(null):(h||(a=t._lookupGid(i(c[f],"gid"),s),h=a[0],l=a[1]),d[g].push(v-h)),f++}}var y=t._extend({tileW:t.sheet(l).tileW,tileH:t.sheet(l).tileH,sheet:l,tiles:d},e(r)),x=y.Class||"TileLayer";y.collision?n.collisionLayer(new t[x](y)):n.insert(new t[x](y))},t._tmxProcessObjectLayer=function(n,s,o,r){for(var a=r.querySelectorAll("object"),h=0;h<a.length;h++){var l=a[h],c=i(l,"gid"),u=i(l,"x"),p=i(l,"y"),d=o[c],f=e(l);if(!d)throw"Invalid TMX Object: missing properties for GID:"+c;if(!d.Class)throw"Invalid TMX Object: missing Class for GID:"+c;var g=d.Class;if(!g)throw"Invalid TMX Object Class: "+g+" GID:"+c;var m=t._extend(t._extend({x:u,y:p},d),f),v=new t[g](m);v.p.x+=v.p.w/2,v.p.y-=v.p.h/2,n.insert(v)}},t._tmxProcessors={objectgroup:t._tmxProcessObjectLayer,layer:t._tmxProcessTileLayer,imagelayer:t._tmxProcessImageLayer},t.stageTMX=function(i,e){var n=t._isString(i)?t.asset(i):i,s={},o=n.getElementsByTagName("tileset"),r=t._tmxLoadTilesets(o,s);t._each(n.documentElement.childNodes,function(i){var n=i.tagName;t._tmxProcessors[n]&&t._tmxProcessors[n](e,r,s,i)})}},Quintus.Touch=function(t){if(t._isUndefined(Quintus.Sprites))throw"Quintus.Touch requires Quintus.Sprites Module";var i=[0],e=0;t.Evented.extend("TouchSystem",{init:function(){var i=this;this.boundTouch=function(t){i.touch(t)},this.boundDrag=function(t){i.drag(t)},this.boundEnd=function(t){i.touchEnd(t)},t.el.addEventListener("touchstart",this.boundTouch),t.el.addEventListener("mousedown",this.boundTouch),t.el.addEventListener("touchmove",this.boundDrag),t.el.addEventListener("mousemove",this.boundDrag),t.el.addEventListener("touchend",this.boundEnd),t.el.addEventListener("mouseup",this.boundEnd),t.el.addEventListener("touchcancel",this.boundEnd),this.touchPos=new t.Evented,this.touchPos.grid={},this.touchPos.p={w:1,h:1,cx:0,cy:0},this.activeTouches={},this.touchedObjects={}},destroy:function(){t.el.removeEventListener("touchstart",this.boundTouch),t.el.removeEventListener("mousedown",this.boundTouch),t.el.removeEventListener("touchmove",this.boundDrag),t.el.removeEventListener("mousemove",this.boundDrag),t.el.removeEventListener("touchend",this.boundEnd),t.el.removeEventListener("mouseup",this.boundEnd),t.el.removeEventListener("touchcancel",this.boundEnd)},normalizeTouch:function(i,e){var n=i.offsetX,s=i.offsetY;if((t._isUndefined(n)||t._isUndefined(s))&&(n=i.layerX,s=i.layerY),t._isUndefined(n)||t._isUndefined(s)){if(void 0===t.touch.offsetX){t.touch.offsetX=0,t.touch.offsetY=0;var o=t.el;do t.touch.offsetX+=o.offsetLeft,t.touch.offsetY+=o.offsetTop;while(o=o.offsetParent)}n=i.pageX-t.touch.offsetX,s=i.pageY-t.touch.offsetY}return this.touchPos.p.ox=this.touchPos.p.px=n/t.cssWidth*t.width,this.touchPos.p.oy=this.touchPos.p.py=s/t.cssHeight*t.height,e.viewport&&(this.touchPos.p.px/=e.viewport.scale,this.touchPos.p.py/=e.viewport.scale,this.touchPos.p.px+=e.viewport.x,this.touchPos.p.py+=e.viewport.y),this.touchPos.p.x=this.touchPos.p.px,this.touchPos.p.y=this.touchPos.p.py,this.touchPos.obj=null,this.touchPos},touch:function(n){for(var s=n.changedTouches||[n],o=0;o<s.length;o++)for(var r=0;r<i.length;r++){var a=s[o],h=t.stage(i[r]);if(h){a.identifier=a.identifier||0;var l=this.normalizeTouch(a,h);h.regrid(l,!0);var c,u=h.search(l,e);if((u||r===i.length-1)&&(c=u&&u.obj,l.obj=c,this.trigger("touch",l)),c&&!this.touchedObjects[c]){this.activeTouches[a.identifier]={x:l.p.px,y:l.p.py,origX:c.p.x,origY:c.p.y,sx:l.p.ox,sy:l.p.oy,identifier:a.identifier,obj:c,stage:h},this.touchedObjects[c.p.id]=!0,c.trigger("touch",this.activeTouches[a.identifier]);break}}}},drag:function(t){for(var i=t.changedTouches||[t],e=0;e<i.length;e++){var n=i[e];n.identifier=n.identifier||0;var s=this.activeTouches[n.identifier],o=s&&s.stage;if(s){var r=this.normalizeTouch(n,o);s.x=r.p.px,s.y=r.p.py,s.dx=r.p.ox-s.sx,s.dy=r.p.oy-s.sy,s.obj.trigger("drag",s)}}t.preventDefault()},touchEnd:function(t){for(var i=t.changedTouches||[t],e=0;e<i.length;e++){var n=i[e];n.identifier=n.identifier||0;var s=this.activeTouches[n.identifier];s&&(s.obj.trigger("touchEnd",s),delete this.touchedObjects[s.obj.p.id],this.activeTouches[n.identifier]=null)}t.preventDefault()}}),t.touch=function(n,s){return t.untouch(),e=n||t.SPRITE_UI,i=s||[2,1,0],t._isArray(i)||(i=[i]),t._touch||(t.touchInput=new t.TouchSystem),t},t.untouch=function(){return t.touchInput&&(t.touchInput.destroy(),delete t.touchInput),t}},Quintus.UI=function(t){if(t._isUndefined(Quintus.Touch))throw"Quintus.UI requires Quintus.Touch Module";t.UI={},t.UI.roundRect=function(t,i){t.beginPath(),t.moveTo(-i.cx+i.radius,-i.cy),t.lineTo(-i.cx+i.w-i.radius,-i.cy),t.quadraticCurveTo(-i.cx+i.w,-i.cy,-i.cx+i.w,-i.cy+i.radius),t.lineTo(-i.cx+i.w,-i.cy+i.h-i.radius),t.quadraticCurveTo(-i.cx+i.w,-i.cy+i.h,-i.cx+i.w-i.radius,-i.cy+i.h),t.lineTo(-i.cx+i.radius,-i.cy+i.h),t.quadraticCurveTo(-i.cx,-i.cy+i.h,-i.cx,-i.cy+i.h-i.radius),t.lineTo(-i.cx,-i.cy+i.radius),t.quadraticCurveTo(-i.cx,-i.cy,-i.cx+i.radius,-i.cy),t.closePath()},t.UI.Container=t.Sprite.extend("UI.Container",{init:function(i,e){var n,s=t._clone(i||{});i&&t._isString(i.w)&&(n=i.w.match(/^[0-9]+%$/))&&(s.w=parseInt(i.w,10)*t.width/100,s.x=t.width/2-s.w/2),i&&t._isString(i.h)&&(n=i.h.match(/^[0-9]+%$/))&&(s.h=parseInt(i.h,10)*t.height/100,s.y=t.height/2-s.h/2),this._super(t._defaults(s,e),{opacity:1,hidden:!1,fill:null,highlight:null,radius:5,stroke:"#000",border:!1,shadow:!1,shadowColor:!1,outlineWidth:!1,outlineColor:"#000",type:t.SPRITE_NONE})},insert:function(t){return this.stage.insert(t,this),t},fit:function(t,i){if(0!==this.children.length){void 0===t&&(t=0),void 0===i&&(i=t);for(var e=1/0,n=1/0,s=-1/0,o=-1/0,r=0;r<this.children.length;r++){var a=this.children[r],h=a.p.x-a.p.cx,l=a.p.y-a.p.cy,c=a.p.x-a.p.cx+a.p.w,u=a.p.y-a.p.cy+a.p.h;e>h&&(e=h),n>l&&(n=l),c>s&&(s=c),u>o&&(o=u)}this.p.cx=-e+i,this.p.cy=-n+t,this.p.w=s-e+2*i,this.p.h=o-n+2*t}},addShadow:function(i){if(this.p.shadow){var e=t._isNumber(this.p.shadow)?this.p.shadow:5;i.shadowOffsetX=e,i.shadowOffsetY=e,i.shadowColor=this.p.shadowColor||"rgba(0,0,50,0.1)"}},clearShadow:function(t){t.shadowColor="transparent"},drawRadius:function(i){t.UI.roundRect(i,this.p),this.addShadow(i),i.fill(),this.p.border&&(this.clearShadow(i),i.lineWidth=this.p.border,i.stroke())},drawSquare:function(t){this.addShadow(t),this.p.fill&&t.fillRect(-this.p.cx,-this.p.cy,this.p.w,this.p.h),this.p.border&&(this.clearShadow(t),t.lineWidth=this.p.border,t.strokeRect(-this.p.cx,-this.p.cy,this.p.w,this.p.h))},draw:function(t){return this.p.hidden?!1:void((this.p.border||this.p.fill)&&(t.globalAlpha=this.p.opacity,t.fillStyle=1===this.p.frame&&this.p.highlight?this.p.highlight:this.p.fill,t.strokeStyle=this.p.stroke,this.p.radius>0?this.drawRadius(t):this.drawSquare(t)))}}),t.UI.Text=t.Sprite.extend("UI.Text",{init:function(i,e){this._super(t._defaults(i||{},e),{type:t.SPRITE_UI,size:24}),this.p.label&&this.calcSize()},calcSize:function(){this.setFont(t.ctx),this.splitLabel=this.p.label.split("\n");for(var i="",e=0;e<this.splitLabel.length;e++)this.splitLabel[e].length>i.length&&(i=this.splitLabel[e]);var n=t.ctx.measureText(i);this.p.h=(this.p.size||24)*this.splitLabel.length*1.2,this.p.w=n.width,this.p.cx=this.p.w/2,this.p.cy=this.p.h/2},prerender:function(){this.p.oldLabel!==this.p.label&&(this.p.oldLabel=this.p.label,this.calcSize(),this.el.width=this.p.w,this.el.height=4*this.p.h,this.ctx.clearRect(0,0,this.p.w,this.p.h),this.ctx.fillStyle="#FF0",this.ctx.fillRect(0,0,this.p.w,this.p.h/2),this.setFont(this.ctx),this.ctx.fillText(this.p.label,0,0))},draw:function(t){if(0!==this.p.opacity){this.p.oldLabel!==this.p.label&&this.calcSize(),this.setFont(t),void 0!==this.p.opacity&&(t.globalAlpha=this.p.opacity);for(var i=0;i<this.splitLabel.length;i++)"center"===this.p.align?(this.p.outlineWidth&&t.strokeText(this.splitLabel[i],0,-this.p.cy+i*this.p.size*1.2),t.fillText(this.splitLabel[i],0,-this.p.cy+i*this.p.size*1.2)):"right"===this.p.align?(this.p.outlineWidth&&t.strokeText(this.splitLabel[i],this.p.cx,-this.p.cy+i*this.p.size*1.2),t.fillText(this.splitLabel[i],this.p.cx,-this.p.cy+i*this.p.size*1.2)):(this.p.outlineWidth&&t.strokeText(this.splitLabel[i],-this.p.cx,-this.p.cy+i*this.p.size*1.2),t.fillText(this.splitLabel[i],-this.p.cx,-this.p.cy+i*this.p.size*1.2))}},asset:function(){return this.el},setFont:function(t){t.textBaseline="top",t.font=this.font(),t.fillStyle=this.p.color||"black",t.textAlign=this.p.align||"left",t.strokeStyle=this.p.outlineColor||"black",t.lineWidth=this.p.outlineWidth||0},font:function(){return this.fontString?this.fontString:(this.fontString=(this.p.weight||"800")+" "+(this.p.size||24)+"px "+(this.p.family||"Arial"),this.fontString)}}),t.UI.Button=t.UI.Container.extend("UI.Button",{init:function(i,e,n){if(this._super(t._defaults(i||{},e),{type:t.SPRITE_UI|t.SPRITE_DEFAULT,keyActionName:null}),this.p.label&&(!this.p.w||!this.p.h)){t.ctx.save(),this.setFont(t.ctx);var s=t.ctx.measureText(this.p.label);t.ctx.restore(),this.p.h||(this.p.h=44),this.p.w||(this.p.w=s.width+20)}isNaN(this.p.cx)&&(this.p.cx=this.p.w/2),isNaN(this.p.cy)&&(this.p.cy=this.p.h/2),this.callback=n,this.on("touch",this,"highlight"),this.on("touchEnd",this,"push"),this.p.keyActionName&&t.input.on(this.p.keyActionName,this,"push")},highlight:function(){"undefined"!=typeof this.sheet()&&this.sheet().frames>1&&(this.p.frame=1)
},push:function(){this.p.frame=0,this.callback&&this.callback(),this.trigger("click")},draw:function(i){this._super(i),(this.p.asset||this.p.sheet)&&t.Sprite.prototype.draw.call(this,i),this.p.label&&(i.save(),this.setFont(i),i.fillText(this.p.label,0,0),i.restore())},setFont:function(t){t.textBaseline="middle",t.font=this.p.font||"400 24px arial",t.fillStyle=this.p.fontColor||"black",t.textAlign="center"}}),t.UI.IFrame=t.Sprite.extend("UI.IFrame",{init:function(i){this._super(i,{opacity:1,type:t.SPRITE_UI|t.SPRITE_DEFAULT}),t.wrapper.style.overflow="hidden",this.iframe=document.createElement("IFRAME"),this.iframe.setAttribute("src",this.p.url),this.iframe.style.position="absolute",this.iframe.style.zIndex=500,this.iframe.setAttribute("width",this.p.w),this.iframe.setAttribute("height",this.p.h),this.iframe.setAttribute("frameborder",0),this.p.background&&(this.iframe.style.backgroundColor=this.p.background),t.wrapper.appendChild(this.iframe),this.on("inserted",function(t){this.positionIFrame(),t.on("destroyed",this,"remove")})},positionIFrame:function(){var t=this.p.x,i=this.p.y;this.stage.viewport&&(t-=this.stage.viewport.x,i-=this.stage.viewport.y),(this.oldX!==t||this.oldY!==i||this.oldOpacity!==this.p.opacity)&&(this.iframe.style.top=i-this.p.cy+"px",this.iframe.style.left=t-this.p.cx+"px",this.iframe.style.opacity=this.p.opacity,this.oldX=t,this.oldY=i,this.oldOpacity=this.p.opacity)},step:function(t){this._super(t),this.positionIFrame()},remove:function(){this.iframe&&(t.wrapper.removeChild(this.iframe),this.iframe=null)}}),t.UI.HTMLElement=t.Sprite.extend("UI.HTMLElement",{init:function(i){this._super(i,{opacity:1,type:t.SPRITE_UI}),t.wrapper.style.overflow="hidden",this.el=document.createElement("div"),this.el.innerHTML=this.p.html,t.wrapper.appendChild(this.el),this.on("inserted",function(t){this.position(),t.on("destroyed",this,"remove"),t.on("clear",this,"remove")})},position:function(){},step:function(t){this._super(t),this.position()},remove:function(){this.el&&(t.wrapper.removeChild(this.el),this.el=null)}}),t.UI.VerticalLayout=t.Sprite.extend("UI.VerticalLayout",{init:function(t){this.children=[],this._super(t,{type:0})},insert:function(t){return this.stage.insert(t,this),this.relayout(),t},relayout:function(){for(var t=0,i=0;i<this.children.length;i++)t+=this.children[i].p.h||0;this.p.h-t}})};